\documentclass[11pt,a4paper,openany]{book}
% Suppress LaTeX3 tagging/structure debug output that leaks to title page
\providecommand\NewTaggingSocket[2]{}
\providecommand\NewTaggingSocketPlug[3]{}
\providecommand\AssignTaggingSocketPlug[2]{}
\providecommand\UseTaggingSocket[1]{}
\providecommand\NewStructureName[1]{}
\providecommand\AssignStructureRole[2]{}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amsthm}
\usepackage{mathtools}
\usepackage{physics}
\usepackage{bm}
\usepackage{geometry}
\usepackage[pdfpagelabels,plainpages=false]{hyperref}
\usepackage{cleveref}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usetikzlibrary{arrows.meta,positioning,shapes,calc,decorations.pathmorphing,decorations.pathreplacing}
\usepackage{enumitem}
\usepackage{booktabs}
\usepackage{tcolorbox}
\tcbuselibrary{breakable}
\usepackage{fontawesome5}
\usepackage{multirow}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{xcolor}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{cutwin}
\usepackage{marginnote}
\usepackage{changepage}  % for adjustwidth
\graphicspath{{images/}{part1/images/}{part2/images/}{part3/images/}{part4/images/}{part5/images/}}

% Prevent flushbottom stretching (book class default) â€” avoids ugly gaps in sparse pages
\raggedbottom

% Tufte-style asymmetric layout: narrower text + wide outer margin for boxes
\geometry{
  inner=1in,
  textwidth=4.5in,
  marginparsep=0.2in,
  marginparwidth=2in,
  top=1in,
  bottom=1in
}

% --- Layout switching: breathing room with side margins ---
% Use \begin{widebreath}...\end{widebreath} around sections that need
% wider margins for phenomenological prose.
\newenvironment{widebreath}{%
  \newgeometry{left=1.6in, right=1.6in, top=1.2in, bottom=1.2in}%
}{%
  \restoregeometry
}

% Use \begin{widemargin}...\end{widemargin} for a wide
% right margin for margin notes / side-column content.
\newenvironment{widemargin}{%
  \newgeometry{left=1.3in, right=3.2in, top=1.2in, bottom=1.2in, marginparwidth=2.6in, marginparsep=0.3in}%
}{%
  \restoregeometry
}

% Margin detail command (works in both modes, but best in widemargin)
\newcommand{\detail}[1]{\marginnote{\footnotesize\color{gray!70!black}#1}}

% --- Side-column boxes: placed in outer margin via \marginnote ---
% Uses \NewDocumentEnvironment{}{+b} to capture body, then place in margin.

% Full-width boxes (too long for margin)
\newtcolorbox{historical}{
  colback=gray!5!white,
  colframe=gray!60!black,
  title={\faBook\hspace{0.5em}Historical Context},
  fonttitle=\bfseries\small,
  fontupper=\small,
  before skip=6pt,
  after skip=6pt,
  breakable
}

\newtcolorbox{connection}{
  colback=green!5!white,
  colframe=green!60!black,
  title={\faBook\hspace{0.5em}Existing Theory},
  fonttitle=\bfseries\scriptsize,
  left=4pt, right=4pt, top=2pt, bottom=2pt,
  fontupper=\scriptsize,
  before skip=6pt,
  after skip=6pt,
  breakable
}

% Connection box - full-width variant (use connection* environment)
\newtcolorbox{connection*}{
  colback=green!5!white,
  colframe=green!60!black,
  title={\faBook\hspace{0.5em}Existing Theory},
  fonttitle=\bfseries\scriptsize,
  left=4pt,
  right=4pt,
  top=2pt,
  bottom=2pt,
  fontupper=\scriptsize,
  before skip=6pt,
  after skip=6pt,
  breakable
}

\newtcolorbox{empirical}{
  colback=orange!5!white,
  colframe=orange!70!black,
  title={\faFlask\hspace{0.5em}Empirical Grounding},
  fonttitle=\bfseries\small
}

\newtcolorbox{todo_empirical}{
  colback=yellow!10!white,
  colframe=yellow!60!black,
  title={\faClipboardList\hspace{0.5em}\textsc{Future Empirical Work}},
  fonttitle=\bfseries\small,
  fontupper=\small,
  before skip=6pt,
  after skip=6pt,
  breakable
}

% Open question: genuinely unresolved, inviting investigation
\newtcolorbox{openquestion}{
  colback=violet!3!white,
  colframe=violet!40!black,
  title={\faQuestion\hspace{0.5em}Open Question},
  fonttitle=\bfseries\small,
  breakable
}

% Proposed experiment: specific study design to test a claim
\newtcolorbox{experiment}{
  colback=teal!5!white,
  colframe=teal!60!black,
  title={\faFlask\hspace{0.5em}Proposed Experiment},
  fonttitle=\bfseries\small,
  breakable
}

\newtcolorbox{sidebar}[1][]{
  colback=blue!3!white,
  colframe=blue!40!black,
  fonttitle=\bfseries\small,
  before upper={\faInfoCircle\hspace{0.5em}},
  breakable,
  #1
}

\newtcolorbox{software}{
  colback=cyan!5!white,
  colframe=cyan!60!black,
  title={\faCode\hspace{0.5em}\textsc{Proposed Software Implementation}},
  fonttitle=\bfseries\small,
  breakable
}

% Section numbering: no chapter prefix, reset per part
\renewcommand{\thesection}{\arabic{section}}
\makeatletter
\@addtoreset{section}{part}
\makeatother

% Theorem environments - numbered within sections
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{axiom}[theorem]{Axiom}
\newtheorem{remark}[theorem]{Remark}
\newtheorem{example}[theorem]{Example}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{hypothesis}[theorem]{Hypothesis}

% Custom commands
\newcommand{\E}{\mathbb{E}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\prob}{\mathbb{P}}
\newcommand{\KL}{\mathrm{KL}}
\newcommand{\MI}{\mathrm{I}}
\newcommand{\entropy}{\mathrm{H}}
\newcommand{\argmax}{\operatorname{argmax}}
\newcommand{\argmin}{\operatorname{argmin}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\rank}{\operatorname{rank}}
\newcommand{\diag}{\operatorname{diag}}
\newcommand{\sign}{\operatorname{sign}}
\newcommand{\supp}{\operatorname{supp}}
\newcommand{\interior}{\operatorname{int}}
\newcommand{\clos}{\operatorname{cl}}
\newcommand{\conv}{\operatorname{conv}}
\newcommand{\diam}{\operatorname{diam}}
\newcommand{\vol}{\operatorname{vol}}
\newcommand{\manifold}{\mathcal{M}}
\newcommand{\viable}{\mathcal{V}}
\newcommand{\belief}{\mathbf{b}}
\newcommand{\state}{\mathbf{s}}
\newcommand{\action}{\mathbf{a}}
\newcommand{\obs}{\mathbf{o}}
\newcommand{\latent}{\mathbf{z}}
\newcommand{\policy}{\pi}
\newcommand{\value}{V}
\newcommand{\qfunc}{Q}
\newcommand{\reward}{r}
\newcommand{\transition}{T}
\newcommand{\emission}{O}
\newcommand{\freeenergy}{\mathcal{F}}
\newcommand{\intinfo}{\Phi}
\newcommand{\selfmodel}{\mathcal{S}}
\newcommand{\worldmodel}{\mathcal{W}}
\newcommand{\effrank}{r_{\text{eff}}}
\newcommand{\valence}{\mathcal{V}\hspace{-0.8pt}\mathit{al}}
\newcommand{\arousal}{\mathcal{A}\hspace{-0.5pt}\mathit{r}}
\newcommand{\cestructure}{\mathcal{C\!E}}
\newcommand{\phenom}{\mathcal{P}}
\newcommand{\distinction}{\delta}
\newcommand{\relation}{\rho}

% Aliases for Parts IV and V notation compatibility
\newcommand{\Val}{\valence}
\newcommand{\Ar}{\arousal}
\newcommand{\reff}{\effrank}
\newcommand{\cfweight}{\mathrm{CF}}
\newcommand{\selfsal}{\mathrm{SM}}

% --- styled callout boxes (side-column via margin) ---
\NewDocumentEnvironment{keyresult}{+b}{%
  \marginnote{%
    \begin{tcolorbox}[
      colback=blue!5!white,
      colframe=blue!75!black,
      title={\faLightbulb\hspace{0.5em}Key Result},
      fonttitle=\bfseries\scriptsize,
      fontupper=\scriptsize,
      left=3pt, right=3pt, top=2pt, bottom=2pt
    ]
    #1
    \end{tcolorbox}%
  }%
}{}
\NewDocumentEnvironment{phenomenal}{+b}{%
  \marginnote{%
    \begin{tcolorbox}[
      colback=purple!5!white,
      colframe=purple!75!black,
      title=Phenomenal Correspondence,
      fonttitle=\scriptsize,
      fontupper=\scriptsize,
      left=3pt, right=3pt, top=2pt, bottom=2pt
    ]
    #1
    \end{tcolorbox}%
  }%
}{}
\NewDocumentEnvironment{warning}{+b}{%
  \marginnote{%
    \begin{tcolorbox}[
      colback=red!5!white,
      colframe=red!75!black,
      title=Warning,
      fonttitle=\scriptsize,
      fontupper=\scriptsize,
      left=3pt, right=3pt, top=2pt, bottom=2pt
    ]
    #1
    \end{tcolorbox}%
  }%
}{}
\newenvironment{normimp}{\begin{quote}\textbf{Normative Implication.} }{\end{quote}}

% Logos epigraph - the thesis speaking as itself
\newtcolorbox{logos}{
  colback=gray!3!white,
  colframe=gray!30!black,
  boxrule=0.5pt,
  left=15pt,
  right=15pt,
  top=10pt,
  bottom=10pt,
  fontupper=\itshape\small,
  before skip=15pt,
  after skip=15pt,
  arc=0pt,
  outer arc=0pt,
  leftrule=2pt,
  rightrule=0pt,
  toprule=0pt,
  bottomrule=0pt,
  breakable
}

% Title page (symmetric margins)
\begin{document}
\newgeometry{margin=1in}
\pagenumbering{gobble}
\pagestyle{empty}
\null\thispagestyle{empty}
\vspace*{2cm}
\begin{center}
{\Huge\bfseries The Shape of Experience}\\[0.3em]
\rule{0.6\textwidth}{0.4pt}\\[1.5em]
{\Large A Geometric Theory of Affect\\[0.3em]
for Biological and Artificial Systems}\\[4cm]
{\large By Me}
\end{center}
\vfill
\newpage

% Table of contents
\pagenumbering{roman}
\setcounter{page}{1}
\tableofcontents
\pagebreak
\restoregeometry  % back to asymmetric margin layout

% Introduction
\chapter*{Introduction}
\addcontentsline{toc}{chapter}{Introduction}
\input{introduction}

% Main matter
\mainmatter

% Part I
\newgeometry{margin=1in}
\part{Thermodynamic Foundations and the Ladder of Emergence}
\restoregeometry
\input{part1/chapter}

% Part II
\newgeometry{margin=1in}
\part{The Identity Thesis and the Geometry of Feeling}
\restoregeometry
\input{part2/chapter}

% Part III
\newgeometry{margin=1in}
\part{Signatures of Affect Under the Existential Burden}
\restoregeometry
\input{part3/chapter}

% Part IV
\newgeometry{margin=1in}
\part{Interventions Across Scale---From Neurons to Nations}
\restoregeometry
\input{part4/chapter}

% Part V
\newgeometry{margin=1in}
\part{The Transcendence of the Self}
\restoregeometry
\input{part5/chapter}

% Back matter
\backmatter

% Epilogue
\chapter*{Epilogue}
\addcontentsline{toc}{chapter}{Epilogue}
\input{epilogue}

\end{document}
